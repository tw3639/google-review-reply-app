import streamlit as st
from prompt_builder import build_prompt
from openai_client import generate_reply
from ai_likeness import calc_ai_likeness
from csv_batch import csv_batch_generate

# -----------------------------
# ãƒšãƒ¼ã‚¸è¨­å®š
# -----------------------------
st.set_page_config(
    page_title="Review Reply QA",
    layout="wide"
)

# -----------------------------
# ã‚¿ã‚¤ãƒˆãƒ« & èª¬æ˜
# -----------------------------
st.title("Review Reply QA")

st.markdown("""
Googleãƒ¬ãƒ“ãƒ¥ãƒ¼ã¸ã®è¿”ä¿¡æ–‡ã‚’ã€â˜…è©•ä¾¡ã”ã¨ã®æ–¹é‡ã«åŸºã¥ã„ã¦ç”Ÿæˆã™ã‚‹ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚  
å®šå‹çš„ãªAIè¿”ä¿¡ã‚’é¿ã‘ã€**äººãŒæ›¸ã„ãŸã‚ˆã†ã«è‡ªç„¶ã«è¦‹ãˆã‚‹è¡¨ç¾**ã‚’é‡è¦–ã—ã¦ã„ã¾ã™ã€‚
""")

with st.expander("ã“ã®ãƒ„ãƒ¼ãƒ«ã«ã¤ã„ã¦"):
    st.markdown("""
    **ä¸»ãªç‰¹å¾´**
    - â˜…1ã€œâ˜…5ã§è¿”ä¿¡ã®ç›®çš„ãƒ»ãƒˆãƒ¼ãƒ³ã‚’æ˜ç¢ºã«åˆ†é›¢
    - ãƒ¬ãƒ“ãƒ¥ãƒ¼æ–‡ã®å†…å®¹ã‹ã‚‰è¿”ä¿¡ã‚¹ã‚¿ã‚¤ãƒ«ã‚’èª¿æ•´
    - å®šå‹æ–‡ã‚’é¿ã‘ãŸè‡ªç„¶ãªæ–‡ç« ç”Ÿæˆ
    - ã€ŒAIã£ã½ã•ã€ã‚’å‚è€ƒã‚¹ã‚³ã‚¢ã¨ã—ã¦å¯è¦–åŒ–

    â€» è‡ªå‹•ç”Ÿæˆã•ã‚ŒãŸè¿”ä¿¡æ–‡ã¯ã€å¿…ãšå†…å®¹ã‚’ã”ç¢ºèªã®ã†ãˆã”åˆ©ç”¨ãã ã•ã„ã€‚
    """)

st.divider()

# -----------------------------
# ãƒ¢ãƒ¼ãƒ‰é¸æŠ
# -----------------------------
mode = st.radio(
    "ãƒ¢ãƒ¼ãƒ‰é¸æŠ",
    ["å˜ä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼", "CSVä¸€æ‹¬ç”Ÿæˆï¼ˆè»½é‡ï¼‰"]
)

# =====================================================
# å˜ä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼
# =====================================================
if mode == "å˜ä½“ãƒ¬ãƒ“ãƒ¥ãƒ¼":
    st.subheader("â‘  ãƒ¬ãƒ“ãƒ¥ãƒ¼å…¥åŠ›")

    review = st.text_area(
        "ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡",
        height=180,
        placeholder="ã“ã“ã«Googleãƒ¬ãƒ“ãƒ¥ãƒ¼ã®æœ¬æ–‡ã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"
    )

    rating = st.selectbox(
        "â˜…è©•ä¾¡",
        [1, 2, 3, 4, 5]
    )

    st.divider()

    st.subheader("â‘¡ è¿”ä¿¡ç”Ÿæˆ")

    if st.button("è¿”ä¿¡ã‚’ç”Ÿæˆã™ã‚‹"):
        if not review.strip():
            st.error("ãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ã€‚")
        else:
            prompt, meta = build_prompt(review, rating)

            with st.spinner("è¿”ä¿¡æ–‡ã‚’ç”Ÿæˆä¸­..."):
                st.session_state.reply = generate_reply(
                    prompt,
                    temperature=meta["temperature"]
                )

    # -----------------------------
    # ç”Ÿæˆæ¸ˆã¿è¿”ä¿¡ãŒã‚ã‚‹å ´åˆã®ã¿è¡¨ç¤º
    # -----------------------------
    if "reply" in st.session_state:
        st.subheader("ç”Ÿæˆã•ã‚ŒãŸè¿”ä¿¡æ–‡ï¼ˆç·¨é›†å¯ï¼‰")

        edited_reply = st.text_area(
            "å¿…è¦ã«å¿œã˜ã¦è¡¨ç¾ã‚’èª¿æ•´ã—ã¦ãã ã•ã„",
            st.session_state.reply,
            height=240
        )

        # -----------------------------
        # AIã£ã½ã•ã‚¹ã‚³ã‚¢è¡¨ç¤ºï¼ˆç·¨é›†å¾Œï¼‰
        # -----------------------------
        score = calc_ai_likeness(edited_reply)

        st.markdown("### ğŸ§ª AIã£ã½ã•ã‚¹ã‚³ã‚¢")
        st.caption(
            "ã“ã®ã‚¹ã‚³ã‚¢ã¯ã€æ–‡ç« ã®ä¸­ã«å«ã¾ã‚Œã‚‹**å®šå‹çš„ãƒ»æ©Ÿæ¢°çš„ã«è¦‹ãˆã‚„ã™ã„è¡¨ç¾ã®å‚¾å‘**ã‚’"
            "ç‹¬è‡ªåŸºæº–ã§æ•°å€¤åŒ–ã—ãŸã‚‚ã®ã§ã™ã€‚"
        )

        st.progress(score / 100)
        st.markdown(f"**ã‚¹ã‚³ã‚¢ï¼š{score} / 100**")

        with st.expander("AIã£ã½ã•ã‚¹ã‚³ã‚¢ã®è€ƒãˆæ–¹ï¼ˆå¿…ãšãŠèª­ã¿ãã ã•ã„ï¼‰"):
            st.markdown("""
            ã“ã®ã‚¹ã‚³ã‚¢ã¯ **å“è³ªãƒ»è‰¯ã—æ‚ªã—ã‚’åˆ¤å®šã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“**ã€‚

            - é«˜ã‚¹ã‚³ã‚¢ã§ã‚‚ã€æ¥­å‹™ä¸Šã¾ã£ãŸãå•é¡Œãªãä½¿ãˆã‚‹æ–‡ç« ã¯å¤šãå­˜åœ¨ã—ã¾ã™
            - ä½ã‚¹ã‚³ã‚¢ã§ã‚‚ã€å¿…ãšã—ã‚‚ã€Œæ­£è§£ã®è¡¨ç¾ã€ã¨ã„ã†ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“

            ã‚ãã¾ã§  
            **ã€Œè‡ªåˆ†ã§æ‰‹ç›´ã—ã—ãŸçµæœã€å®šå‹AIæ„ŸãŒã©ã†å¤‰åŒ–ã—ãŸã‹ã‚’ç¢ºèªã™ã‚‹ãŸã‚ã®è£œåŠ©æŒ‡æ¨™ã€**  
            ã¨ã—ã¦ã”æ´»ç”¨ãã ã•ã„ã€‚
            """)

# =====================================================
# CSVä¸€æ‹¬ç”Ÿæˆï¼ˆè»½é‡ï¼‰
# =====================================================
elif mode == "CSVä¸€æ‹¬ç”Ÿæˆï¼ˆè»½é‡ï¼‰":
    st.subheader("â‘  CSVã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰")

    st.markdown("""
    CSVãƒ•ã‚¡ã‚¤ãƒ«ã«è¤‡æ•°ã®ãƒ¬ãƒ“ãƒ¥ãƒ¼ã‚’ã¾ã¨ã‚ã¦ã€è¿”ä¿¡æ–‡ã‚’ä¸€æ‹¬ç”Ÿæˆã—ã¾ã™ã€‚  
    **æ¤œè¨¼ãƒ»ç¤¾å†…ç¢ºèªç”¨é€”å‘ã‘ã®è»½é‡ãƒ¢ãƒ¼ãƒ‰**ã§ã™ã€‚
    """)

    with st.expander("CSVã®å½¢å¼ä¾‹"):
        st.markdown("""
        ä»¥ä¸‹ã®ã‚ˆã†ãªå½¢å¼ã®CSVã‚’ã”ç”¨æ„ãã ã•ã„ã€‚

        ```csv
        review,rating
        ã¨ã¦ã‚‚ä¸å¯§ãªæ¥å®¢ã§ã—ãŸã€‚,5
        æ–™ç†ã®æä¾›ãŒé…ã‹ã£ãŸã§ã™ã€‚,2
        æ™®é€šã§ã—ãŸã€‚,3
        ```

        - `review`ï¼šãƒ¬ãƒ“ãƒ¥ãƒ¼æœ¬æ–‡  
        - `rating`ï¼šâ˜…è©•ä¾¡ï¼ˆ1ã€œ5ã®æ•°å€¤ï¼‰
        """)

    uploaded = st.file_uploader(
        "CSVã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ˆreview,rating ã®åˆ—ãŒå¿…è¦ï¼‰",
        type="csv"
    )

    if uploaded:
        with st.spinner("CSVä¸€æ‹¬ç”Ÿæˆä¸­..."):
            df = csv_batch_generate(uploaded)

        st.subheader("ç”Ÿæˆçµæœ")
        st.dataframe(df, use_container_width=True)

        st.caption(
            "â€» ä¸€æ‹¬ç”Ÿæˆã§ã¯APIä½¿ç”¨é‡ãŒå¢—ãˆã‚‹ãŸã‚ã€ä»¶æ•°ã«ã¯ã”æ³¨æ„ãã ã•ã„ã€‚"
        )
